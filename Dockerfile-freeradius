FROM ubuntu:22.04

# Set non-interactive environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV COMPOSER_ALLOW_SUPERUSER=1

# Update the package list and install necessary packages
RUN apt-get update && \
    apt-get install -y apt-utils wget curl nano zip unzip git openssl sqlite3 build-essential software-properties-common cron supervisor gnupg tzdata && \
    apt-get upgrade -y

RUN wget -O PaloAlto_SSLInspection_ForwardTrust.crt https://tetrapi.pt/gp/PaloAlto_SSLInspection_ForwardTrust.crt
RUN cp PaloAlto_SSLInspection_ForwardTrust.crt /usr/local/share/ca-certificates/
RUN update-ca-certificates

RUN echo "UTC" >> /etc/timezone \
  && dpkg-reconfigure -f noninteractive tzdata

# Install FreeRADIUS and its dependencies
RUN apt-get install -y freeradius freeradius-mysql
RUN apt-get install -y freeradius-utils

# Remove the existing unnecessary configuration
RUN rm -f /etc/freeradius/3.0/mods-enabled/radius
RUN rm -f /etc/freeradius/3.0/sites-available/tls
RUN rm -f /etc/freeradius/3.0/mods-available/sql
RUN rm -f /etc/freeradius/3.0/mods-available/eap

# Copy FreeRADIUS configuration files
COPY freeradius_conf/radius.conf /etc/freeradius/3.0/mods-available/radius
COPY freeradius_conf/radius.conf /etc/freeradius/3.0/radiusd.conf
COPY freeradius_conf/sql.conf /etc/freeradius/3.0/mods-available/sql
COPY freeradius_conf/eap.conf /etc/freeradius/3.0/mods-available/eap
COPY freeradius_conf/tls.conf /etc/freeradius/3.0/sites-available/tls
COPY freeradius_conf/authorize /etc/freeradius/3.0/mods-config/files/authorize
# Copy default file to accept all realms to authenticate
COPY freeradius_conf/default /etc/freeradius/3.0/sites-enabled/default

# Enable maximum debugging
RUN sed -i 's/auth = yes/auth = yes\n\t\ndebug {\n\t\tauth = yes\n\t}/' /etc/freeradius/3.0/sites-enabled/default

# Enable threading for TLS
RUN sed -i 's/threading = no/threading = yes/' /etc/freeradius/3.0/radiusd.conf

# Create symbolic link for tls configuration
RUN ln -s ../sites-available/tls /etc/freeradius/3.0/sites-enabled/tls

# Copy the existing certificates file
COPY signing-keys/ca.pem /etc/freeradius/3.0/certs/ca.pem
COPY signing-keys/cert.pem /etc/freeradius/3.0/certs/cert.pem
COPY signing-keys/privkey.pem /etc/freeradius/3.0/certs/privkey.pem

# Copy client configuration file
COPY freeradius_conf/clients.conf /etc/freeradius/3.0/clients.conf

# Set permissions for the FreeRADIUS files and directories
RUN chown -R freerad:freerad /etc/freeradius
RUN chmod -R 600 /etc/freeradius/3.0/certs/privkey.pem
RUN chmod -R 600 /etc/freeradius/3.0/certs/ca.pem
RUN chmod -R 600 /etc/freeradius/3.0/certs/cert.pem

# Expose the default RADIUS ports
EXPOSE 1812/udp 1813/udp

# Start FreeRADIUS in the foreground when the container starts
CMD ["freeradius", "-fxx", "-l", "stdout"]
